<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="asg4.css">

 <!-- Include socket.io client API from cdn //-->
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

<script>
      /////////////////////// SOCKET_IO STUFF ///////////////
     // USEFUL NOTES???

      // TO-SERVER LOGIN screen-name 
      // server: LOGIN-OK list-of-logged-in-screennames-and-status
      // NEW-GAME screen-name choice-of-X-or-O
      // server: UPDATED-USER-LIST-AND-STATUS list-of-screen-names status
      // JOIN client’s-screen-name opponent’s-screen-name
      // server: UPDATED-USER-LIST-AND-STATUS list-of-screen-names status
      // PLAY X-player-screen-name O-player-screen-name (server to only the 2 players)
      // Send message to Server. 
	// Will create a connection if one is not already established
      // MOVE screen-name cell-number (1 to 9)
      // END-GAME, [ winner [ X | O ] screen-name] OR END-GAME, D
     
	function sendToServer(messageType, message) {
  		try {
    			if (!connectedSocket) createSocket();
    			connectedSocket.emit(messageType, message); // send msg to server
  		} catch (err) {
    			alert("System error 987: " + err + " contact us, or try again later");
  		}
	}
      var connectedSocket = null;
      function createSocket() {
            try {
                  connectedSocket = io(window.location.hostname+":8081");
            } catch (err) {
                  alert('connectedSocket create error, contact us');
                  connectedSocket = null;
                  return;
            }

            connectedSocket.on("general-msg", function (message) {
			//alert(message.message);
                  if(message.activeList) {
                        fillActives(message.activeList);
                        fillIdles(message.idleList);
                  }
        	});

            connectedSocket.on("LOGIN-FAIL", function (message) {
			//alert(message.message);
                  document.getElementById("error_msg").innerHTML = message.message;
                  document.getElementById('main_box').style.visibility = 'hidden'
                  document.getElementById('Log_in_screen').style.visibility = 'visible'
        	});

      }

      let  Intervalid 

      function update_players(){
            Intervalid ??= setInterval(Update_players, 1000)
      }
      function Update_players(){
            
           connectedSocket.emit("UPDATE");
      }
      
      
      var screen_name = "";
      
      function logout() {
            //connectedSocket.emit("TO-SERVER LOGOUT", screen_name);
            //connectedSocket = null;
            document.getElementById("main_box").style.visibility = 'hidden';
            document.getElementById('Log_in_screen').style.visibility = 'visible'
      }
      function open_help_menu(){
            document.getElementById("Help_menu").style.visibility = 'visible'
      }

      function close_help_menu(){
            document.getElementById("Help_menu").style.visibility = 'hidden'
      }
       function show_main_box(){
            document.getElementById('main_box').style.visibility = 'visible'
            document.getElementById('Log_in_screen').style.visibility = 'hidden'

      }


      //////////////////////////// DATA BASE STUFF ///////////////////////////

      function addToDB() {
            screen_name = document.getElementById('Screenname').value;
            if (screen_name == '') {return}

            connectedSocket.emit("TO-SERVER LOGIN", screen_name);
      }

      function newGameButton() {
            //make the pop up come up
            // select x or o
            document.getElementById('x_or_o').style.visibility = 'visible';
      }

      function makeGame(choice) {
            //makes server call with screen name and choice
            connectedSocket.emit("NEW-GAME", {'screen_name' : screen_name, 'choice_of_X_or_O': choice});
      }
      
      function join_game(button){
            
            sendToServer('JOIN', button );
            toggle_game_div()
      }
      function leave_game(button){
            sendToServer('EXIT', button);

      }

      function fillActives(givenHTML) {
            document.getElementById("actives").innerHTML = givenHTML;
      }
      
      function fillIdles(givenHTML) {
            document.getElementById("idle").innerHTML = givenHTML;
      }

            /////////////////////Game board actions//////////////////////////
      function toggle_game_div(button) {
            if(document.getElementById('game_window').style.display == 'none') {
                  document.getElementById('game_window').style.display = 'block';
            } else {
                  document.getElementById('game_window').style.display = 'none';    
            }
      }

      let isXTurn = true; 
      let x_num = 2;
      let o_num = 1;
      var move_count  = 0;
       function Take_turn(button){
       const gameSquare = button.parentElement;
          

        // Create a new image element
        const newImage = document.createElement('img');
        newImage.style.maxWidth = '100%';
        newImage.style.maxHeight = '100%'; 
        newImage.style.display = 'block'; 

        if (isXTurn) {
            newImage.src = 'X.png'; 
            newImage.alt = 'X';
            button.parentElement.id = x_num;
            document.getElementById("whoTurn").innerHTML = "O's Turn";
        } else {
            newImage.src = 'O.webp'; 
            newImage.alt = 'O';
            button.parentElement.id = o_num;
            document.getElementById("whoTurn").innerHTML = "X's Turn";
        }
        console.log(button.parentElement.id)
        button.remove();
        gameSquare.appendChild(newImage);
         x_num += 2;
         o_num += 2;
       
        isXTurn = !isXTurn;

        move_count ++
            
            if (move_count >= 4){
                 Game_status_check()
            }
       }

            let ABC = true
            let DEF = true
            let GHI = true

            let ADG = true
            let BEH = true
            let CFI = true

            let AEI =  true
            let CEG = true 

            let A_val 
            let B_val 
            let C_val

            let D_val 
            let E_val 
            let F_val

            let G_val 
            let H_val 
            let I_val 

            
      function Game_status_check(){
            console.log (ABC)
            
            const A = document.getElementsByName('1')[0];
            const B = document.getElementsByName('2')[0];
            const C = document.getElementsByName('3')[0];

            const D = document.getElementsByName('4')[0];
            const E = document.getElementsByName('5')[0];
            const F = document.getElementsByName('6')[0];

            const G = document.getElementsByName('7')[0];
            const H = document.getElementsByName('8')[0];
            const I = document.getElementsByName('9')[0];
            
            A_val =  (parseInt(A.id) % 2)
            B_val =  (parseInt(B.id) % 2)
            C_val =  (parseInt(C.id) % 2)

            D_val =  (parseInt(D.id) % 2)
            E_val =  (parseInt(E.id) % 2)
            F_val =  (parseInt(F.id) % 2)

            G_val =  (parseInt(G.id) % 2)
            H_val =  (parseInt(H.id) % 2)
            I_val =  (parseInt(I.id) % 2)

            const A_defined = !(isNaN(A_val));
            const B_defined = !(isNaN(B_val));
            const C_defined = !(isNaN(C_val));

            const D_defined = !(isNaN(D_val));
            const E_defined = !(isNaN(E_val));
            const F_defined = !(isNaN(F_val));

            const G_defined = !(isNaN(G_val));
            const H_defined = !(isNaN(H_val));
            const I_defined = !(isNaN(I_val));


            if ((A_defined && B_defined) && A_val  != B_val ) ABC = false 
            if ((A_defined && C_defined) && A_val  != C_val ) ABC = false
            if ((B_defined && C_defined) && B_val  != C_val ) ABC = false
            console.log("ABC:")
            console.log(ABC)
            if ((E_defined && D_defined) && E_val  != D_val ) DEF = false 
            if ((E_defined && F_defined) && E_val  != F_val ) DEF = false
            if ((D_defined && F_defined) && D_val  != F_val ) DEF = false
            console.log("DEF:")
            console.log(DEF)
            if ((G_defined && H_defined) && G_val  != H_val ) GHI = false 
            if ((G_defined && I_defined) && G_val  != I_val ) GHI = false
            if ((H_defined && I_defined) && H_val  != I_val ) GHI = false
             console.log("GHI:")
            console.log(GHI)


            //DOWN
            if ((A_defined && D_defined) && A_val  != D_val ) ADG = false 
            if ((A_defined && G_defined) && A_val  != G_val ) ADG = false
            if ((D_defined && G_defined) && D_val  != G_val ) ADG = false
             console.log("ADG:")
            console.log(ADG)
            if ((B_defined && E_defined) && B_val  != E_val ) BEH = false 
            if ((B_defined && H_defined) && B_val  != H_val ) BEH = false
            if ((E_defined && H_defined) && E_val  != H_val ) BEH = false
             console.log("BEH:")
            console.log(BEH)
            if ((C_defined && F_defined) && C_val  != F_val ) CFI = false 
            if ((C_defined && I_defined) && C_val  != I_val ) CFI = false
            if ((F_defined && I_defined) && F_val  != I_val ) CFI = false
            console.log("CFI:")
            console.log(CFI)
            if ((A_defined && E_defined) && A_val  != E_val ) AEI = false 
            if ((A_defined && I_defined) && A_val  != I_val ) AEI = false
            if ((E_defined && I_defined) && E_val  != I_val ) AEI = false
            console.log("AEI:")
            console.log(CEG)  
            if ((C_defined && E_defined) && C_val  != E_val ) CEG = false 
            if ((C_defined && G_defined) && C_val  != G_val ) CEG = false
            if ((E_defined && G_defined) && E_val  != G_val ) CEG = false


            const conditions = [ABC,DEF,GHI,ADG,BEH,CFI,AEI,CEG];
            const x_row = []

            // THIS WORKS I THINK????
                  let trueCount = 0;
                  for (let i = 0; i < conditions.length; i++) {
                  if (!conditions[i]) {
                        trueCount++;
                        console.log("LICK")
                        console.log(move_count)
                        console.log(trueCount)
                  }
                  }
                  if (trueCount >= 7 && move_count > 6  && !win_on_last_move()){
                        draw()
                  }


      // game logic 
            //across 

            // this one can be removed i
            // keep this in its the old draw method 

            ///testing block 1 
            /*
            // catches error when last move results in a win, 
            if (!ABC && !DEF && !GHI && !ADG && !BEH && !CFI &&!AEI && !CEG ){
                  console.log("ITS A DRAWWW")
                  draw();
            }*/

            if (ABC){
                  if (( B_val == A_val) && (C_val == A_val  )) {
                        if(A_val  == 0){
                              X_wins();
                        }            
                        else{
                              O_wins()
                        }
                  }
            }
             if(DEF){ 
                  if (( E_val == D_val) && (F_val == D_val )){
                        if(D_val == 0){
                              X_wins()
                        }
                        else{
                              O_wins()
                        }
                  }
            }

             if(GHI){
                  if (( H_val  == G_val  ) && (I_val == G_val )){
                        if(G_val == 0){
                              X_wins()
                        }
                        else{
                              O_wins()
                        }      
                  }      
            } 
            //down
             if(ADG){
                  if (( D_val == A_val ) && (G_val  == A_val  )){

                        if(A_val == 0){
                              
                              X_wins()
                        }
                        else{
                              O_wins()
                        }
                  }
            }
             if (BEH){
                  if (( E_val == B_val ) && (H_val  == B_val )){
                        if(B_val == 0){
                              X_wins()
                        }
                        else{
                              O_wins()
                        } 
                  }
            } 
             if(CFI){
                  if (( F_val  == C_val ) && (I_val == C_val )){
                        if(C_val == 0){
                              X_wins()
                        }
                        else{
                              O_wins()
                        }
                  }
            } 
            // diagonal
             if (AEI){
                  if (( E_val == A_val ) && (I_val == A_val)){
                        if(A_val == 0){
                        X_wins()
                        }
                        else{
                        O_wins()
                        } 
                  }
            }
             if (CEG){

                  if (( E_val  == C_val ) && (G_val  == C_val )){
                        if(C_val == 0){
                        X_wins()
                        }
                        else{
                        O_wins()
                        } 
                  }
            } 
            else{
                  console.log("not a winner")
            } 
      
      }
      function win_on_last_move(){ 
            A_val = A_val ?? 0; // If num1 is undefined or null, use 0
            B_val = B_val ?? 0;
            C_val = C_val ?? 0;

            D_val = D_val ?? 0;
            E_val = E_val ?? 0;
            F_val = F_val ?? 0;

            G_val = G_val ?? 0;
            H_val = H_val ?? 0;
            I_val = I_val ?? 0;

            if (A_val + B_val +C_val == 0){
                  return true 
            }
            if (D_val + E_val +F_val == 0){
                  return true 
            }
            if (G_val + H_val +I_val == 0){
                  return true 
            }
            if (A_val + D_val +G_val == 0){
                  return true 
            }
            if (B_val + E_val + H_val == 0){
                  return true 
            }
            if (C_val + F_val +I_val == 0){
                  return true 
            }
             if (A_val + E_val +I_val == 0){
                  return true 
            }
             if (C_val + E_val +G_val == 0){
                  return true 
            }
            return false
       }
      function hideResultMenu() {
             document.getElementById("result_menu").style.display = "none";
      }

      function post_game_peek(){

            document.getElementById("result_menu-content").style.display = "none";
            document.getElementById("result_menu").style.backgroundColor = "rgba(0, 0, 0, 0)";

            setTimeout(function() {
            
             document.getElementById("result_menu-content").style.display = "flex"
             document.getElementById("result_menu").style.backgroundColor = "rgba(0, 0, 0, .5)";
            }, 2000); // Delay of 2000 milliseconds (2 seconds)
      }
          function disable_game_table(){
            document.querySelectorAll('.game_squares button').forEach(elem => {
             elem.disabled = true;
            });

            function enable_game_table(){
                  document.querySelectorAll('.game_squares button').forEach(elem => {
             elem.disabled = false;
            });

            }
      }

      function X_wins(){
             
            const rmc = document.getElementById("result_menu-content");
            const result_menu = document.getElementById("result_menu");
            result_menu.style.display = 'flex'; 
            rmc.innerHTML = ''// resets everything so last result screen does not show in new game

            
            const win_msg = document.createElement('h1');
            win_msg.innerHTML = "<img src='X.png' style='height: 100px; vertical-align: middle;" +
                                    "margin-right: 50px;'>" +
                                    "X WINS!!!!" +
                                    "<img src='X.png' style='height: 100px; vertical-align: middle;"+
                                    "margin-left: 50px;'>";
            
            const close_button = document.createElement('button');
            close_button.id = 'Result_close_button';
            close_button.innerHTML = "Close";
            close_button.style.width = "500px"
            close_button.style.height = "75px"
            close_button.onclick = hideResultMenu;
            close_button.style.display = 'flex';
            close_button.style.marginLeft = '25px'

            const view_game_table = document.createElement('button');
            view_game_table.id = 'Result_close_button';

            view_game_table.onclick = post_game_peek
            
            view_game_table.innerHTML = "View game board ";

            rmc.appendChild(win_msg);
            win_msg.appendChild(close_button);
            win_msg.appendChild(view_game_table)
            disable_game_table()
      }

      function O_wins(){
            const rmc = document.getElementById("result_menu-content");
            const result_menu = document.getElementById("result_menu");
            result_menu.style.display = 'flex'; 
            rmc.innerHTML = '' // resets everything so last result screen does not show in new game

            const win_msg = document.createElement('h1');
            win_msg.innerHTML = "<img src='O.webp' style='height: 100px; vertical-align: middle;" +
                                    "margin-right: 50px;'>" +
                                    "O WINS!!!!" +
                                    "<img src='O.webp' style='height: 100px; vertical-align: middle;"+
                                    "margin-left: 50px;'>";
            
            const close_button = document.createElement('button');
            close_button.id = 'Result_close_button';
            close_button.innerHTML = "Close";
            close_button.style.width = "500px"
            close_button.style.height = "75px"
            close_button.onclick = hideResultMenu;
            close_button.style.display = 'flex';
            close_button.style.marginLeft = '25px'

            const view_game_table = document.createElement('button');
            view_game_table.id = 'Result_close_button';

            view_game_table.onclick = post_game_peek
            
            view_game_table.innerHTML = "View game board ";

            rmc.appendChild(win_msg);
            win_msg.appendChild(close_button);
            win_msg.appendChild(view_game_table)

            disable_game_table()
      }
      function draw(){
            const rmc = document.getElementById("result_menu-content");
            const result_menu = document.getElementById("result_menu");
            result_menu.style.display = 'flex'; 
            rmc.innerHTML = ''// resets everything so last result screen does not show in new game

            
            const win_msg = document.createElement('h1');
            win_msg.innerHTML = "<img src='X.png' style='height: 100px; vertical-align: middle;" +
                                    "margin-right: 50px;'>" +
                                    "It's a draw!!!" +
                                    "<img src='O.webp' style='height: 100px; vertical-align: middle;"+
                                    "margin-left: 50px;'>";
            
            const close_button = document.createElement('button');
            close_button.id = 'Result_close_button';
            close_button.innerHTML = "Close";
            close_button.style.width = "500px"
            close_button.style.height = "75px"
            close_button.onclick = hideResultMenu;
            close_button.style.display = 'flex';
            close_button.style.marginLeft = '25px'

            const view_game_table = document.createElement('button');
            view_game_table.id = 'Result_close_button';

            view_game_table.onclick = post_game_peek
            
            view_game_table.innerHTML = "View game board ";

            rmc.appendChild(win_msg);
            win_msg.appendChild(close_button);
            win_msg.appendChild(view_game_table)
            disable_game_table()

      }

      // runs connection as soon as script loads
      createSocket();
      update_players()
</script>
</head>
<body>
      <table id="headtable" style="width: 100%;"> <!--creates head table -->
      <tr>
            <!--creates welcome banner and shows it to user-->
            <th colspan="3" style="font-size: 200%;"> <img src="X.png" alt="X" style="height: 40px; float: left;"> THE BEST TIC-TAC-TOE WEBSITE <img src="O.webp" alt="P" style="height: 40px; float: right;" ></th>
      </tr>
      <tr>
            <th colspan="3" style="font-size: 150%; text-align: right; cursor: pointer;" onclick = >
                  <a id= help_box style="text-decoration: none;" href="#"  onclick="open_help_menu()">Help |</a>
                  <a id="help_box" style="text-decoration: none;" href="#" onclick="logout(); return false;">Logout</a> 
            </th>
      </tr>

      </table>

      <div id="Log_in_screen" style="visibility: visible;">
           <h1 style="font-family: Arial, Helvetica, sans-serif">Please create an account:</h1>

            <form onsubmit="return false;"> <!-- doesnt reload the page and hides the menu -->
                  <label style="font-size: 25px; font-family: Arial, Helvetica, sans-serif" for="Screenname">Screen Name:</label><br>
                  <input type="text" id="Screenname"  placeholder="John"><br>

                  <div id= "name_taken" class="err_msg hidden">That Screenname is already taken. Please try a new name</div>
                  <div id = "empty name" class=" err_msg hidden"> name cannot be null</div>

                  <input type="submit" value="Submit" onclick="addToDB(),show_main_box()">
            </form> 
            <!-- send error here -->
      <h1 id="error_msg" style="color: red;">error</h1>
      </div>

      <div id = "main_box" style="visibility: hidden;">
            <center>
            <div id = "idle">
                  idle users:
            </div>
            <div id = "avialable_games">
                 <p  id="avialable_games_headder"> Active games:
                  <button  id = "new_game_button" onclick = "newGameButton()">New Game</button></p>
                  <table id = "actives" style = "border: 2px solid black; border-collapse: collapse; text-align: center; width: 100%; ">
                        
                  </table>
                  
            </div>
            
            
            <div id="x_or_o" style="visibility: hidden;">
                  
                  <div id = "x_or_o_content">
                        <h1>Pick a side to play</h1>
                        <img src="X.png" style="width: 100px; margin-right: 200px;">
                        <img src="O.webp" style="width: 100px;">
                        <div id ="button-container">
                              
                  <button id="pick_x" onclick = "document.getElementById('x_or_o').style.visibility = 'hidden'; makeGame('x')"> X </button>
                  <button id="pick_o" onclick = "document.getElementById('x_or_o').style.visibility = 'hidden'; makeGame('o')"> O </button>

                        </div>
                  </div>
            </div>

            <div id = "game_window" style="">
            <div id = "game_info"> 
                  <div class = "game_info_categories"> <h1 style="text-align: center">X: Screenname</h1></div>
                  <div class = "game_info_categories"> <h1 style="text-align: center" id = "whoTurn">X's TURN</h1></div>
                  <div class = "game_info_categories"> <h1 style="text-align: center">O: Screenname</h1></div>
            </div>
            <div id = "game_contain_squares"> 
                  <div class = "game_squares" name = "1"><button class="board_button" onclick="Take_turn(this)"></button></div>
                  <div class = "game_squares" name = "2"><button class="board_button" onclick="Take_turn(this)"></button></div>
                  <div class = "game_squares" name = "3"><button class="board_button" onclick="Take_turn(this)"></button></div>
                  <div class = "game_squares" name = "4"><button class="board_button" onclick="Take_turn(this)"></button></div>
                  <div class = "game_squares" name = "5"><button class="board_button" onclick="Take_turn(this)"></button></div>
                  <div class = "game_squares" name = "6"><button class="board_button" onclick="Take_turn(this)"></button></div>
                  <div class = "game_squares" name = "7"><button class="board_button" onclick="Take_turn(this)"></button></div>
                  <div class = "game_squares" name = "8"><button class="board_button" onclick="Take_turn(this)"></button></div>
                  <div class = "game_squares" name = "9"><button class="board_button" onclick="Take_turn(this)"></button></div>
            </div>
            <div width="100%" style= "">
                  <h1 onclick="toggle_game_div(),leave_game()" style="cursor: pointer;">LEAVE</h1>
            </div>
            </center>
      </div>
      </div>
      <div>
            
      </div>

      <div id = "Help_menu" style="visibility: hidden;">
            <<!-- remove 'none'absolute-->
            <div class="Help_menu-content">
                  <button onclick="close_help_menu()" class="close-button">X</button> 
                  <h1 style="text-align: center;">Welcome to the best tic-tac-toe website out There</h1>
                  <h3>Created by Ryan and Bear:</h3>
                  <p> Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat.
                        In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar
                        vivamus fringilla lacus nec metus bibendum egestas. 
                        Iaculis massa nisl malesuada lacinia integer nunc posuere.
                        Ut hendrerit semper vel class aptent taciti sociosqu. 
                        Ad litora torquent per conubia nostra inceptos himenaeos. </p>
                  <p>Lorem ipsum dolor sit amet consectetur adipiscing elit.
                        Quisque faucibus ex sapien vitae pellentesque sem placerat. 
                        In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor.
                        Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. 
                        Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos</p>
                  <p>Lorem ipsum dolor sit amet consectetur adipiscing elit. 
                        Quisque faucibus ex sapien vitae pellentesque sem placerat. 
                        In id cursus mi pretium tellus duis convallis. 
                        Tempus leo eu aenean sed diam urna tempor. 
                        Pulvinar vivamus fringilla lacus nec metus bibendum egestas. 
                        Iaculis massa nisl malesuada lacinia integer nunc posuere. 
                        Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per 
                        conubia nostra inceptos himenaeos.Lorem ipsum dolor sit amet consectetur 
                        adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat.
                  </p>
                        

                  
                  </div>
            </div>
      </div>
      <div id="result_menu" style="display: none ">
            <div id="result_menu-content">  
      </div>
</body>
</html>


<!-- MENY NOTES TO NOTE 
 #1 We have a function to give ckiclys back to buttons. we just dont have a spot to call it yet 
 since we need to reset game board after each join and whatnot -->